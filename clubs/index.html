<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東海國小114下社團報名結果公告</title>

    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .controls { margin-bottom: 20px; background: #e9ecef; padding: 20px; border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        select { width: 100%; padding: 12px; font-size: 16px; border-radius: 5px; border: 1px solid #ced4da; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #dee2e6; padding: 12px 8px; text-align: center; }
        th { background: #2c3e50; color: white; }
        tr:nth-child(even) { background: #f8f9fa; }
        .no-data { text-align: center; padding: 40px; color: #6c757d; font-size: 18px; line-height: 1.6; }
        .status-pass { color: #28a745; font-weight: bold; }
        .timer-info { text-align: center; font-size: 0.9em; color: #666; margin-top: 10px; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>

<div class="container">
    <h1>東海國小114下社團報名結果</h1>
    
    <div id="mainContent">
        <div class="controls">
            <label for="clubSelect">請選擇社團名稱：</label>
            <select id="clubSelect" disabled>
                <option value="">檢查公告時間中...</option>
            </select>
        </div>

        <div id="resultArea" class="table-responsive">
            <div class="no-data">請先從上方選單選擇社團</div>
        </div>
    </div>

    <div id="timeMessage" style="display:none;"></div>
    
    <div class="timer-info" id="timerInfo"></div>
</div>

<script>
    // --- 【管理員設定區】 ---
    const config = {
        // 設定開始公告時間 (年, 月-1, 日, 時, 分) 註：月份從0開始，1代表2月
        startTime: new Date(2025, 1, 20, 08, 00), // 2025年2月20日 08:00
        // 設定結束公告時間
        endTime: new Date(2025, 2, 30, 17, 00),   // 2025年3月30日 17:00
        
        csvURL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIzS-_hGz-62j8Ky4aUuJSpeaPTjSHOx85BGfjowRx4-wQQS6gk4ulyNI8GjD1SPhrQLeQpuVtOR9o/pub?gid=0&single=true&output=csv"
    };
    // -----------------------

    let allData = [];

    function checkTimeAndInit() {
        const now = new Date();
        const mainContent = document.getElementById("mainContent");
        const timeMessage = document.getElementById("timeMessage");
        const timerInfo = document.getElementById("timerInfo");

        // 顯示公告區段給使用者參考 (選填)
        timerInfo.innerHTML = `公告期間：${config.startTime.toLocaleString()} ~ ${config.endTime.toLocaleString()}`;

        if (now < config.startTime) {
            // 尚未開始
            mainContent.style.display = "none";
            timeMessage.style.display = "block";
            timeMessage.innerHTML = `<div class="no-data">目前尚未開放查詢。<br>公告開始時間：${config.startTime.toLocaleString()}</div>`;
        } else if (now > config.endTime) {
            // 已經結束
            mainContent.style.display = "none";
            timeMessage.style.display = "block";
            timeMessage.innerHTML = `<div class="no-data">公告查詢期限已過。<br>如有疑問請洽本校教務處。</div>`;
        } else {
            // 在時間範圍內，執行資料讀取
            loadData();
        }
    }

    function loadData() {
        Papa.parse(config.csvURL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                allData = results.data;
                renderClubOptions();
            },
            error: function() {
                document.getElementById("resultArea").innerHTML = "<div class='no-data' style='color:red;'>資料讀取失敗。</div>";
            }
        });
    }

    function renderClubOptions() {
        const clubSelect = document.getElementById("clubSelect");
        const clubs = [...new Set(allData.map(item => item["社團名稱"]))].filter(c => c).sort();

        clubSelect.innerHTML = '<option value="">-- 請選擇社團 --</option>';
        clubs.forEach(club => {
            const option = document.createElement("option");
            option.value = club;
            option.textContent = club;
            clubSelect.appendChild(option);
        });
        clubSelect.disabled = false;
    }

    // 姓名遮罩 logic
    function maskName(name) {
        if (!name || name.includes("○")) return name;
        if (name.length <= 1) return name;
        if (name.length === 2) return name[0] + "○";
        return name[0] + "○" + name.substring(2);
    }

    document.getElementById("clubSelect").addEventListener("change", function() {
        const selectedClub = this.value;
        const resultArea = document.getElementById("resultArea");

        if (!selectedClub) {
            resultArea.innerHTML = '<div class="no-data">請先從上方選單選擇社團</div>';
            return;
        }

        const filtered = allData.filter(row => row["社團名稱"] === selectedClub);
        let tableHtml = `<table><thead><tr><th>年級</th><th>班級</th><th>座號</th><th>姓名</th><th>報名結果</th></tr></thead><tbody>`;

        filtered.forEach(row => {
            const rawName = row["姓名(姓名中間字需顯示\"○\")"] || row["姓名"] || "";
            const status = row["報名結果"] || "";
            tableHtml += `
                <tr>
                    <td>${row["年級"] || ""}</td>
                    <td>${row["班級"] || ""}</td>
                    <td>${row["座號"] || ""}</td>
                    <td>${maskName(rawName)}</td>
                    <td class="${status.includes('錄取') ? 'status-pass' : ''}">${status}</td>
                </tr>
            `;
        });

        tableHtml += '</tbody></table>';
        resultArea.innerHTML = tableHtml;
    });

    // 執行檢查
    checkTimeAndInit();
</script>

</body>
</html>
